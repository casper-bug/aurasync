<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync Music Player</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
        }
        
        .player-container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .control-btn {
            background: #4a4a4a;
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .control-btn:hover {
            background: #5a5a5a;
        }
        
        .control-btn:disabled {
            background: #333;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .slider {
            flex: 1;
            height: 5px;
            background: #4a4a4a;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            background: #007bff;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .volume-slider {
            width: 100px;
            vertical-align: middle;
        }
        
        #status {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            min-height: 20px;
        }
        
        .session-controls {
            margin-bottom: 20px;
        }
        
        .session-controls input, .session-controls button {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #555;
            background: #3a3a3a;
            color: white;
            border-radius: 5px;
        }
        
        .session-controls button {
            background: #007bff;
            cursor: pointer;
        }
        
        .session-controls button:hover {
            background: #0056b3;
        }
        
        .track-info {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .playlist {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 5px;
        }
        
        .track-item {
            padding: 10px;
            margin: 5px 0;
            background: #3a3a3a;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .track-item:hover {
            background: #4a4a4a;
        }
        
        .track-item.active {
            background: #007bff;
        }
    </style>
</head>
<body>
    <h1>Sync Music Player</h1>
    
    <div id="status">Initializing...</div>
    
    <div class="session-controls">
        <input type="text" id="sessionId" placeholder="Enter Session ID">
        <button onclick="createSession()">Create Session</button>
        <button onclick="joinSession()">Join Session</button>
        <span id="currentSession"></span>
    </div>
    
    <div class="player-container">
        <audio id="audio-player" controls style="width: 100%; margin-bottom: 15px;"></audio>
        
        <div class="controls">
            <button class="control-btn" onclick="previousTrack()">‚èÆÔ∏è</button>
            <button class="control-btn" id="playPauseBtn" onclick="togglePlayPause()">‚ñ∂Ô∏è</button>
            <button class="control-btn" onclick="nextTrack()">‚è≠Ô∏è</button>
        </div>
        
        <div class="slider-container">
            <span>0:00</span>
            <input type="range" class="slider" id="progressSlider" min="0" max="100" value="0">
            <span id="duration">0:00</span>
        </div>
        
        <div class="slider-container">
            <span>üîä</span>
            <input type="range" class="slider volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="0.5">
            <span id="volumePercent">50%</span>
        </div>
    </div>
    
    <div class="track-info">
        <h3 id="currentTrack">No track selected</h3>
        <p id="trackDetails">Select a track to play</p>
    </div>
    
    <div class="playlist">
        <h3>Playlist</h3>
        <div id="playlistContainer">
            <div class="track-item" onclick="selectTrack(0)">
                <strong>Sample Track 1</strong><br>
                <small>https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3</small>
            </div>
            <div class="track-item" onclick="selectTrack(1)">
                <strong>Sample Track 2</strong><br>
                <small>https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3</small>
            </div>
            <div class="track-item" onclick="selectTrack(2)">
                <strong>Sample Track 3</strong><br>
                <small>https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3</small>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAqL8w9Qy4N2mRxTkVvJ5HhFgBpL7XcD9E",
            authDomain: "sync-music-player.firebaseapp.com",
            projectId: "sync-music-player",
            storageBucket: "sync-music-player.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456789"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Helper function for DOM selection
        const $ = (id) => document.getElementById(id);

        // Global variables
        let isHost = false;
        let currentSessionId = null;
        let sessionListener = null;
        let currentTrackIndex = 0;
        let isUpdatingFromSync = false;
        
        const audioPlayer = $('audio-player');
        const playPauseBtn = $('playPauseBtn');
        const progressSlider = $('progressSlider');
        const volumeSlider = $('volumeSlider');
        
        // Sample playlist
        const playlist = [
            {
                title: "Sample Track 1",
                url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3",
                artist: "SoundHelix"
            },
            {
                title: "Sample Track 2", 
                url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3",
                artist: "SoundHelix"
            },
            {
                title: "Sample Track 3",
                url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3",
                artist: "SoundHelix"
            }
        ];

        // Status update function
        function status(message) {
            $('status').textContent = message;
            console.log(message);
        }

        // Initialize the player
        function initializePlayer() {
            // Set initial volume
            audioPlayer.volume = 0.5;
            
            // Audio event listeners
            audioPlayer.addEventListener('loadedmetadata', updateDuration);
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('play', onPlay);
            audioPlayer.addEventListener('pause', onPause);
            audioPlayer.addEventListener('ended', onTrackEnd);
            
            // Volume slider
            volumeSlider.addEventListener('input', onVolumeChange);
            
            // Progress slider
            progressSlider.addEventListener('input', onSeek);
            
            status('Player initialized. Create or join a session to start.');
        }

        // Session management
        async function createSession() {
            const sessionId = generateSessionId();
            currentSessionId = sessionId;
            isHost = true;
            
            try {
                await db.collection('sessions').doc(sessionId).set({
                    host: true,
                    currentTrack: 0,
                    isPlaying: false,
                    currentTime: 0,
                    volume: 0.5,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                $('currentSession').textContent = `Session: ${sessionId} (Host)`;
                $('sessionId').value = sessionId;
                
                loadTrack(0);
                enableHostControls();
                startSessionListener();
                
                status('Session created successfully!');
            } catch (error) {
                status('Error creating session: ' + error.message);
            }
        }

        async function joinSession() {
            const sessionId = $('sessionId').value.trim();
            if (!sessionId) {
                status('Please enter a session ID');
                return;
            }
            
            try {
                const sessionDoc = await db.collection('sessions').doc(sessionId).get();
                if (!sessionDoc.exists) {
                    status('Session not found');
                    return;
                }
                
                currentSessionId = sessionId;
                isHost = false;
                
                $('currentSession').textContent = `Session: ${sessionId} (Guest)`;
                
                enableGuestControls();
                startSessionListener();
                
                status('Joined session successfully!');
            } catch (error) {
                status('Error joining session: ' + error.message);
            }
        }

        function generateSessionId() {
            return Math.random().toString(36).substr(2, 9).toUpperCase();
        }

        // Control management
        function enableHostControls() {
            audioPlayer.controls = true;
            document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = false);
            volumeSlider.disabled = false;
            progressSlider.disabled = false;
        }

        function enableGuestControls() {
            audioPlayer.controls = false;
            document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = true);
            volumeSlider.disabled = true;
            progressSlider.disabled = true;
        }

        // Session synchronization
        function startSessionListener() {
            if (sessionListener) {
                sessionListener();
            }
            
            sessionListener = db.collection('sessions').doc(currentSessionId)
                .onSnapshot((doc) => {
                    if (doc.exists && !isHost) {
                        syncWithSession(doc.data());
                    }
                });
        }

        async function syncWithSession(sessionData) {
            if (isUpdatingFromSync) return;
            
            isUpdatingFromSync = true;
            
            try {
                // Sync track
                if (sessionData.currentTrack !== currentTrackIndex) {
                    currentTrackIndex = sessionData.currentTrack;
                    loadTrack(currentTrackIndex);
                }
                
                // Sync volume
                if (Math.abs(audioPlayer.volume - sessionData.volume) > 0.01) {
                    audioPlayer.volume = sessionData.volume;
                    volumeSlider.value = sessionData.volume;
                    $('volumePercent').textContent = Math.round(sessionData.volume * 100) + '%';
                }
                
                // Sync playback state
                if (sessionData.isPlaying && audioPlayer.paused) {
                    audioPlayer.currentTime = sessionData.currentTime;
                    await audioPlayer.play();
                    playPauseBtn.textContent = '‚è∏Ô∏è';
                } else if (!sessionData.isPlaying && !audioPlayer.paused) {
                    audioPlayer.pause();
                    playPauseBtn.textContent = '‚ñ∂Ô∏è';
                }
                
                // Sync time (with tolerance for network delay)
                const timeDiff = Math.abs(audioPlayer.currentTime - sessionData.currentTime);
                if (timeDiff > 1) {
                    audioPlayer.currentTime = sessionData.currentTime;
                }
                
            } catch (error) {
                console.error('Sync error:', error);
            } finally {
                isUpdatingFromSync = false;
            }
        }

        async function updateSession(updates) {
            if (!isHost || !currentSessionId) return;
            
            try {
                await db.collection('sessions').doc(currentSessionId).update({
                    ...updates,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error updating session:', error);
            }
        }

        // Playback controls
        function loadTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            
            currentTrackIndex = index;
            const track = playlist[index];
            
            audioPlayer.src = track.url;
            audioPlayer.load();
            
            $('currentTrack').textContent = track.title;
            $('trackDetails').textContent = `Artist: ${track.artist}`;
            
            // Update playlist UI
            document.querySelectorAll('.track-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
        }

        async function togglePlayPause() {
            if (!isHost) return;
            
            try {
                if (audioPlayer.paused) {
                    await audioPlayer.play();
                } else {
                    audioPlayer.pause();
                }
            } catch (error) {
                status('Playback error: ' + error.message);
            }
        }

        function nextTrack() {
            if (!isHost) return;
            
            const nextIndex = (currentTrackIndex + 1) % playlist.length;
            loadTrack(nextIndex);
            updateSession({
                currentTrack: nextIndex,
                currentTime: 0,
                isPlaying: false
            });
        }

        function previousTrack() {
            if (!isHost) return;
            
            const prevIndex = currentTrackIndex === 0 ? playlist.length - 1 : currentTrackIndex - 1;
            loadTrack(prevIndex);
            updateSession({
                currentTrack: prevIndex,
                currentTime: 0,
                isPlaying: false
            });
        }

        function selectTrack(index) {
            if (!isHost) return;
            
            loadTrack(index);
            updateSession({
                currentTrack: index,
                currentTime: 0,
                isPlaying: false
            });
        }

        // Event handlers
        function updateDuration() {
            const duration = formatTime(audioPlayer.duration);
            $('duration').textContent = duration;
            progressSlider.max = audioPlayer.duration;
        }

        function updateProgress() {
            if (!isUpdatingFromSync && !progressSlider.matches(':active')) {
                progressSlider.value = audioPlayer.currentTime;
                const currentTime = formatTime(audioPlayer.currentTime);
                progressSlider.previousElementSibling.textContent = currentTime;
            }
        }

        function onPlay() {
            playPauseBtn.textContent = '‚è∏Ô∏è';
            if (isHost) {
                updateSession({
                    isPlaying: true,
                    currentTime: audioPlayer.currentTime
                });
            }
        }

        function onPause() {
            playPauseBtn.textContent = '‚ñ∂Ô∏è';
            if (isHost) {
                updateSession({
                    isPlaying: false,
                    currentTime: audioPlayer.currentTime
                });
            }
        }

        function onTrackEnd() {
            if (isHost) {
                nextTrack();
            }
        }

        function onVolumeChange() {
            if (!isHost) return;
            
            const volume = parseFloat(volumeSlider.value);
            audioPlayer.volume = volume;
            $('volumePercent').textContent = Math.round(volume * 100) + '%';
            
            updateSession({ volume });
        }

        function onSeek() {
            if (!isHost) return;
            
            const seekTime = parseFloat(progressSlider.value);
            audioPlayer.currentTime = seekTime;
            
            updateSession({
                currentTime: seekTime
            });
        }

        // Utility functions
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializePlayer);
    </script>
</body>
</html>
