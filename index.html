<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync Music Player</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
        }
        
        .player-container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .control-btn {
            background: #4a4a4a;
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:hover:not(:disabled) {
            background: #5a5a5a;
        }
        
        .control-btn:disabled {
            background: #333;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .control-btn .material-icons {
            font-size: 20px;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .slider {
            flex: 1;
            height: 5px;
            background: #4a4a4a;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            background: #007bff;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            background: #007bff;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .volume-slider {
            width: 100px;
        }
        
        #status {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            min-height: 20px;
        }
        
        .session-controls {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .session-controls input {
            padding: 8px 12px;
            border: 1px solid #555;
            background: #3a3a3a;
            color: white;
            border-radius: 5px;
            min-width: 150px;
        }
        
        .session-controls button {
            padding: 8px 12px;
            border: 1px solid #555;
            background: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .session-controls button:hover {
            background: #0056b3;
        }
        
        .track-info {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .add-track-section {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .add-track-form {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .add-track-form input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #555;
            background: #3a3a3a;
            color: white;
            border-radius: 5px;
            min-width: 200px;
        }
        
        .add-track-form button {
            padding: 8px 15px;
            border: none;
            background: #28a745;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .add-track-form button:hover {
            background: #218838;
        }
        
        .playlist {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 5px;
        }
        
        .track-item {
            padding: 12px;
            margin: 8px 0;
            background: #3a3a3a;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .track-item:hover {
            background: #4a4a4a;
        }
        
        .track-item.active {
            background: #007bff;
        }
        
        .track-item.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .track-info-text {
            flex: 1;
        }
        
        .track-duration {
            color: #aaa;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .remove-track {
            background: #dc3545;
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .remove-track:hover {
            background: #c82333;
        }
        
        .volume-icon {
            display: flex;
            align-items: center;
        }
        
        .time-display {
            min-width: 40px;
            text-align: center;
            font-size: 12px;
        }
        
        .loading {
            opacity: 0.7;
        }
        
        .error {
            color: #ff6b6b;
        }
        
        .success {
            color: #51cf66;
        }
        
        .youtube-preview {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .youtube-preview img {
            width: 60px;
            height: 45px;
            border-radius: 3px;
            margin-right: 10px;
        }
        
        .youtube-preview-content {
            display: flex;
            align-items: center;
        }
        
        .youtube-preview-info {
            flex: 1;
        }
    </style>
</head>
<body>
    <h1>ðŸŽµ Sync Music Player</h1>
    
    <div id="status">Initializing player...</div>
    
    <div class="session-controls">
        <input type="text" id="sessionId" placeholder="Enter Session ID">
        <button onclick="createSession()">Create Session</button>
        <button onclick="joinSession()">Join Session</button>
        <button onclick="leaveSession()">Leave Session</button>
        <span id="currentSession"></span>
    </div>
    
    <div class="player-container">
        <div class="controls">
            <button class="control-btn" onclick="previousTrack()" disabled>
                <span class="material-icons">skip_previous</span>
            </button>
            <button class="control-btn" id="playPauseBtn" onclick="togglePlayPause()" disabled>
                <span class="material-icons">play_arrow</span>
            </button>
            <button class="control-btn" onclick="nextTrack()" disabled>
                <span class="material-icons">skip_next</span>
            </button>
        </div>
        
        <div class="slider-container">
            <span class="time-display">0:00</span>
            <input type="range" class="slider" id="progressSlider" min="0" max="100" value="0" disabled>
            <span class="time-display" id="duration">0:00</span>
        </div>
        
        <div class="slider-container">
            <span class="volume-icon material-icons">volume_up</span>
            <input type="range" class="slider volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="0.5" disabled>
            <span id="volumePercent">50%</span>
        </div>
    </div>
    
    <div class="track-info">
        <h3 id="currentTrack">No track selected</h3>
        <p id="trackDetails">Create or join a session to start playing music</p>
    </div>
    
    <div class="add-track-section">
        <h3>Add Music</h3>
        <div class="add-track-form">
            <input type="text" id="youtubeUrl" placeholder="Enter YouTube URL or search term">
            <button onclick="addTrackFromYoutube()">Add Track</button>
        </div>
        <div id="youtubePreview" class="youtube-preview"></div>
        <p><small>You can add YouTube URLs or search for songs. Note: This is a demo - actual YouTube integration would require API keys and proper audio extraction.</small></p>
    </div>
    
    <div class="playlist">
        <h3>Playlist <span id="playlistCount">(0 tracks)</span></h3>
        <div id="playlistContainer">
            <p style="color: #888; text-align: center; padding: 20px;">
                No tracks in playlist. Add some music above to get started!
            </p>
        </div>
    </div>

    <script>
        // Simulated backend - in real implementation, use Firebase or your preferred backend
        class MockBackend {
            constructor() {
                this.sessions = new Map();
                this.listeners = new Map();
            }
            
            async createSession(sessionId, data) {
                this.sessions.set(sessionId, { ...data, created: Date.now() });
                this.notifyListeners(sessionId, this.sessions.get(sessionId));
                return true;
            }
            
            async updateSession(sessionId, updates) {
                if (this.sessions.has(sessionId)) {
                    const current = this.sessions.get(sessionId);
                    const updated = { ...current, ...updates, lastUpdate: Date.now() };
                    this.sessions.set(sessionId, updated);
                    this.notifyListeners(sessionId, updated);
                    return true;
                }
                return false;
            }
            
            async getSession(sessionId) {
                return this.sessions.get(sessionId) || null;
            }
            
            onSnapshot(sessionId, callback) {
                if (!this.listeners.has(sessionId)) {
                    this.listeners.set(sessionId, new Set());
                }
                this.listeners.get(sessionId).add(callback);
                
                // Return unsubscribe function
                return () => {
                    const sessionListeners = this.listeners.get(sessionId);
                    if (sessionListeners) {
                        sessionListeners.delete(callback);
                    }
                };
            }
            
            notifyListeners(sessionId, data) {
                const sessionListeners = this.listeners.get(sessionId);
                if (sessionListeners) {
                    sessionListeners.forEach(callback => {
                        setTimeout(() => callback({ exists: true, data: () => data }), 0);
                    });
                }
            }
        }

        // Initialize mock backend
        const backend = new MockBackend();

        // Helper function for DOM selection
        const $ = (id) => document.getElementById(id);

        // Global variables
        let isHost = false;
        let currentSessionId = null;
        let sessionListener = null;
        let currentTrackIndex = 0;
        let isUpdatingFromSync = false;
        let syncUpdateTimeout = null;
        let playlist = [];
        
        const audioPlayer = new Audio();
        const playPauseBtn = $('playPauseBtn');
        const progressSlider = $('progressSlider');
        const volumeSlider = $('volumeSlider');

        // Status update function
        function status(message, type = 'info') {
            const statusEl = $('status');
            statusEl.textContent = message;
            statusEl.className = type;
            console.log(message);
        }

        // Initialize the player
        function initializePlayer() {
            // Set initial volume
            audioPlayer.volume = 0.5;
            audioPlayer.crossOrigin = 'anonymous';
            
            // Audio event listeners
            audioPlayer.addEventListener('loadedmetadata', updateDuration);
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('play', onPlay);
            audioPlayer.addEventListener('pause', onPause);
            audioPlayer.addEventListener('ended', onTrackEnd);
            audioPlayer.addEventListener('error', onAudioError);
            audioPlayer.addEventListener('loadstart', () => status('Loading track...'));
            audioPlayer.addEventListener('canplay', () => status('Track ready to play', 'success'));
            
            // Volume slider
            volumeSlider.addEventListener('input', onVolumeChange);
            
            // Progress slider
            progressSlider.addEventListener('input', onSeek);
            progressSlider.addEventListener('change', onSeek);
            
            status('Player initialized. Create or join a session to start.');
        }

        // Session management
        async function createSession() {
            const sessionId = generateSessionId();
            currentSessionId = sessionId;
            isHost = true;
            
            try {
                const initialData = {
                    host: true,
                    currentTrack: 0,
                    isPlaying: false,
                    currentTime: 0,
                    volume: 0.5,
                    playlist: playlist
                };
                
                await backend.createSession(sessionId, initialData);
                
                $('currentSession').textContent = `Session: ${sessionId} (Host)`;
                $('sessionId').value = sessionId;
                
                enableHostControls();
                startSessionListener();
                
                status('Session created successfully! Share the session ID with others.', 'success');
            } catch (error) {
                status('Error creating session: ' + error.message, 'error');
            }
        }

        async function joinSession() {
            const sessionId = $('sessionId').value.trim().toUpperCase();
            if (!sessionId) {
                status('Please enter a session ID', 'error');
                return;
            }
            
            try {
                const sessionData = await backend.getSession(sessionId);
                if (!sessionData) {
                    status('Session not found. Please check the session ID.', 'error');
                    return;
                }
                
                currentSessionId = sessionId;
                isHost = false;
                
                $('currentSession').textContent = `Session: ${sessionId} (Guest)`;
                
                // Sync playlist
                playlist = sessionData.playlist || [];
                updatePlaylistUI();
                
                enableGuestControls();
                startSessionListener();
                
                // Sync immediately with current session state
                await syncWithSession(sessionData);
                
                status('Joined session successfully!', 'success');
            } catch (error) {
                status('Error joining session: ' + error.message, 'error');
            }
        }

        function leaveSession() {
            if (sessionListener) {
                sessionListener();
                sessionListener = null;
            }
            
            currentSessionId = null;
            isHost = false;
            
            audioPlayer.pause();
            audioPlayer.src = '';
            
            disableAllControls();
            
            $('currentSession').textContent = '';
            $('currentTrack').textContent = 'No track selected';
            $('trackDetails').textContent = 'Create or join a session to start playing music';
            
            status('Left session. Create or join a session to continue.');
        }

        function generateSessionId() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        // Control management
        function enableHostControls() {
            document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = false);
            volumeSlider.disabled = false;
            progressSlider.disabled = false;
            document.querySelectorAll('.track-item').forEach(item => {
                item.classList.remove('disabled');
            });
        }

        function enableGuestControls() {
            document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = true);
            volumeSlider.disabled = false; // Guests can control their own volume
            progressSlider.disabled = true;
            document.querySelectorAll('.track-item').forEach(item => {
                item.classList.add('disabled');
            });
        }

        function disableAllControls() {
            document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = true);
            volumeSlider.disabled = true;
            progressSlider.disabled = true;
            document.querySelectorAll('.track-item').forEach(item => {
                item.classList.add('disabled');
            });
        }

        // Session synchronization
        function startSessionListener() {
            if (sessionListener) {
                sessionListener();
            }
            
            sessionListener = backend.onSnapshot(currentSessionId, (doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (!isHost) {
                        syncWithSession(data);
                    }
                } else {
                    status('Session ended or deleted.');
                    leaveSession();
                }
            });
        }

        async function syncWithSession(sessionData) {
            if (isUpdatingFromSync) return;
            
            isUpdatingFromSync = true;
            
            try {
                // Sync playlist
                if (JSON.stringify(playlist) !== JSON.stringify(sessionData.playlist || [])) {
                    playlist = sessionData.playlist || [];
                    updatePlaylistUI();
                }
                
                // Sync track
                if (sessionData.currentTrack !== currentTrackIndex && playlist.length > 0) {
                    currentTrackIndex = sessionData.currentTrack;
                    loadTrack(currentTrackIndex);
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Sync volume for guests
                if (!isHost && Math.abs(audioPlayer.volume - sessionData.volume) > 0.01) {
                    audioPlayer.volume = sessionData.volume;
                    volumeSlider.value = sessionData.volume;
                    $('volumePercent').textContent = Math.round(sessionData.volume * 100) + '%';
                }
                
                // Sync playback state
                const timeDiff = Math.abs(audioPlayer.currentTime - (sessionData.currentTime || 0));
                
                if (sessionData.isPlaying && audioPlayer.paused) {
                    if (timeDiff > 1) {
                        audioPlayer.currentTime = sessionData.currentTime || 0;
                    }
                    try {
                        await audioPlayer.play();
                        playPauseBtn.innerHTML = '<span class="material-icons">pause</span>';
                    } catch (error) {
                        console.log('Play failed:', error);
                    }
                } else if (!sessionData.isPlaying && !audioPlayer.paused) {
                    audioPlayer.pause();
                    playPauseBtn.innerHTML = '<span class="material-icons">play_arrow</span>';
                }
                
                // Sync time if significant difference
                if (!audioPlayer.paused && timeDiff > 2) {
                    audioPlayer.currentTime = sessionData.currentTime || 0;
                }
                
            } catch (error) {
                console.error('Sync error:', error);
            } finally {
                setTimeout(() => {
                    isUpdatingFromSync = false;
                }, 100);
            }
        }

        async function updateSession(updates) {
            if (!isHost || !currentSessionId || isUpdatingFromSync) return;
            
            if (syncUpdateTimeout) {
                clearTimeout(syncUpdateTimeout);
            }
            
            syncUpdateTimeout = setTimeout(async () => {
                try {
                    await backend.updateSession(currentSessionId, updates);
                } catch (error) {
                    console.error('Error updating session:', error);
                }
            }, 100);
        }

        // YouTube integration (simulated)
        async function addTrackFromYoutube() {
            const input = $('youtubeUrl').value.trim();
            if (!input) {
                status('Please enter a YouTube URL or search term', 'error');
                return;
            }
            
            status('Processing YouTube request...', 'loading');
            
            try {
                // Simulate YouTube API call
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                let track;
                if (input.includes('youtube.com') || input.includes('youtu.be')) {
                    // Extract video ID and create track
                    const videoId = extractYouTubeVideoId(input);
                    track = {
                        id: Date.now().toString(),
                        title: `YouTube Video ${videoId}`,
                        artist: 'YouTube',
                        url: generateDemoAudioUrl(), // Demo audio URL
                        thumbnail: `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`,
                        duration: '3:42',
                        source: 'youtube'
                    };
                } else {
                    // Search term
                    track = {
                        id: Date.now().toString(),
                        title: input,
                        artist: 'Search Result',
                        url: generateDemoAudioUrl(),
                        thumbnail: 'https://via.placeholder.com/120x90/333/fff?text=Music',
                        duration: '3:30',
                        source: 'youtube'
                    };
                }
                
                playlist.push(track);
                updatePlaylistUI();
                
                if (isHost && currentSessionId) {
                    await updateSession({ playlist });
                }
                
                $('youtubeUrl').value = '';
                status('Track added successfully!', 'success');
                
            } catch (error) {
                status('Error adding track: ' + error.message, 'error');
            }
        }

        function extractYouTubeVideoId(url) {
            const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/);
            return match ? match[1] : 'demo123';
        }

        function generateDemoAudioUrl() {
            const demoUrls = [
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3'
            ];
            return demoUrls[Math.floor(Math.random() * demoUrls.length)];
        }

        // Playlist management
        function updatePlaylistUI() {
            const container = $('playlistContainer');
            const countEl = $('playlistCount');
            
            countEl.textContent = `(${playlist.length} tracks)`;
            
            if (playlist.length === 0) {
                container.innerHTML = `
                    <p style="color: #888; text-align: center; padding: 20px;">
                        No tracks in playlist. Add some music above to get started!
                    </p>
                `;
                return;
            }
            
            container.innerHTML = playlist.map((track, index) => `
                <div class="track-item ${index === currentTrackIndex ? 'active' : ''}" onclick="selectTrack(${index})">
                    <div class="track-info-text">
                        <strong>${track.title}</strong><br>
                        <small>${track.artist}</small>
                    </div>
                    <div>
                        <span class="track-duration">${track.duration}</span>
                        ${isHost ? `<button class="remove-track" onclick="removeTrack(${index}); event.stopPropagation();">Ã—</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function removeTrack(index) {
            if (!isHost) return;
            
            playlist.splice(index, 1);
            
            if (currentTrackIndex >= index) {
                currentTrackIndex = Math.max(0, currentTrackIndex - 1);
            }
            
            updatePlaylistUI();
            
            if (currentSessionId) {
                updateSession({ 
                    playlist,
                    currentTrack: currentTrackIndex
                });
            }
            
            if (playlist.length === 0) {
                audioPlayer.pause();
                audioPlayer.src = '';
                $('currentTrack').textContent = 'No track selected';
                $('trackDetails').textContent = 'Add tracks to continue playing';
            }
        }

        // Playback controls
        function loadTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            
            currentTrackIndex = index;
            const track = playlist[index];
            
            audioPlayer.src = track.url;
            audioPlayer.load();
            
            $('currentTrack').textContent = track.title;
            $('trackDetails').textContent = `Artist: ${track.artist} â€¢ Duration: ${track.duration}`;
            
            updatePlaylistUI();
        }

        async function togglePlayPause() {
            if (!isHost || !currentSessionId || playlist.length === 0) return;
            
            try {
                if (audioPlayer.paused) {
                    await audioPlayer.play();
                } else {
                    audioPlayer.pause();
                }
            } catch (error) {
                status('Playback error: ' + error.message, 'error');
            }
        }

        function nextTrack() {
            if (!isHost || !currentSessionId || playlist.length === 0) return;
            
            const nextIndex = (currentTrackIndex + 1) % playlist.length;
            loadTrack(nextIndex);
            updateSession({
                currentTrack: nextIndex,
                currentTime: 0,
                isPlaying: false
            });
        }

        function previousTrack() {
            if (!isHost || !currentSessionId || playlist.length === 0) return;
            
            const prevIndex = currentTrackIndex === 0 ? playlist.length - 1 : currentTrackIndex - 1;
            loadTrack(prevIndex);
            updateSession({
                currentTrack: prevIndex,
                currentTime: 0,
                isPlaying: false
            });
        }

        function selectTrack(index) {
            if (!isHost || !currentSessionId) return;
            
            loadTrack(index);
            updateSession({
                currentTrack: index,
                currentTime: 0,
                isPlaying: false
            });
        }

        // Event handlers
        function updateDuration() {
            const duration = formatTime(audioPlayer.duration);
            $('duration').textContent = duration;
            progressSlider.max = audioPlayer.duration || 100;
        }

        function updateProgress() {
            if (!isUpdatingFromSync && document.activeElement !== progressSlider) {
                progressSlider.value = audioPlayer.currentTime || 0;
                const currentTime = formatTime(audioPlayer.currentTime || 0);
                progressSlider.previousElementSibling.textContent = currentTime;
            }
        }

        function onPlay() {
            playPauseBtn.innerHTML = '<span class="material-icons">pause</span>';
            if (isHost && !isUpdatingFromSync) {
                updateSession({
                    isPlaying: true,
                    currentTime: audioPlayer.currentTime || 0
                });
            }
        }

        function onPause() {
            playPauseBtn.innerHTML = '<span class="material-icons">play_arrow</span>';
            if (isHost && !isUpdatingFromSync) {
                updateSession({
                    isPlaying: false,
                    currentTime: audioPlayer.currentTime || 0
                });
            }
        }

        function onTrackEnd() {
            if (isHost && playlist.length > 1) {
                nextTrack();
            }
        }

        function onAudioError(e) {
            status('Audio error: Unable to load track', 'error');
            console.error('Audio error:', e);
        }

        function onVolumeChange() {
            const volume = parseFloat(volumeSlider.value);
            audioPlayer.volume = volume;
            $('volumePercent').textContent = Math.round(volume * 100) + '%';
            
            if (isHost) {
                updateSession({ volume });
            }
        }

        function onSeek() {
            if (!isHost) return;
            
            const seekTime = parseFloat(progressSlider.value);
            audioPlayer.currentTime = seekTime;
            
            updateSession({
                currentTime: seekTime
            });
        }

        // Utility functions
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds === null || seconds === undefined) return '0:00';
            
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializePlayer);

        // Handle Enter key in YouTube input
        $('youtubeUrl').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTrackFromYoutube();
            }
        });
    </script>
</body>
</html>
