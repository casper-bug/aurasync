<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync Music Player</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
        }
        
        .player-container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .control-btn {
            background: #4a4a4a;
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:hover {
            background: #5a5a5a;
        }
        
        .control-btn:disabled {
            background: #333;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .control-btn .material-icons {
            font-size: 20px;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .slider {
            flex: 1;
            height: 5px;
            background: #4a4a4a;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            background: #007bff;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            background: #007bff;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .volume-slider {
            width: 100px;
            vertical-align: middle;
        }
        
        #status {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            min-height: 20px;
        }
        
        .session-controls {
            margin-bottom: 20px;
        }
        
        .session-controls input, .session-controls button {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #555;
            background: #3a3a3a;
            color: white;
            border-radius: 5px;
        }
        
        .session-controls button {
            background: #007bff;
            cursor: pointer;
        }
        
        .session-controls button:hover {
            background: #0056b3;
        }
        
        .track-info {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .playlist {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 5px;
        }
        
        .track-item {
            padding: 10px;
            margin: 5px 0;
            background: #3a3a3a;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .track-item:hover {
            background: #4a4a4a;
        }
        
        .track-item.active {
            background: #007bff;
        }
        
        .volume-icon {
            display: flex;
            align-items: center;
        }
        
        .time-display {
            min-width: 40px;
            text-align: center;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Sync Music Player</h1>
    
    <div id="status">Initializing...</div>
    
    <div class="session-controls">
        <input type="text" id="sessionId" placeholder="Enter Session ID">
        <button onclick="createSession()">Create Session</button>
        <button onclick="joinSession()">Join Session</button>
        <button onclick="leaveSession()">Leave Session</button>
        <span id="currentSession"></span>
    </div>
    
    <div class="player-container">
        <audio id="audio-player" style="width: 100%; margin-bottom: 15px;" preload="metadata"></audio>
        
        <div class="controls">
            <button class="control-btn" onclick="previousTrack()" disabled>
                <span class="material-icons">skip_previous</span>
            </button>
            <button class="control-btn" id="playPauseBtn" onclick="togglePlayPause()" disabled>
                <span class="material-icons">play_arrow</span>
            </button>
            <button class="control-btn" onclick="nextTrack()" disabled>
                <span class="material-icons">skip_next</span>
            </button>
        </div>
        
        <div class="slider-container">
            <span class="time-display">0:00</span>
            <input type="range" class="slider" id="progressSlider" min="0" max="100" value="0" disabled>
            <span class="time-display" id="duration">0:00</span>
        </div>
        
        <div class="slider-container">
            <span class="volume-icon material-icons">volume_up</span>
            <input type="range" class="slider volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="0.5" disabled>
            <span id="volumePercent">50%</span>
        </div>
    </div>
    
    <div class="track-info">
        <h3 id="currentTrack">No track selected</h3>
        <p id="trackDetails">Create or join a session to start playing music</p>
    </div>
    
    <div class="playlist">
        <h3>Playlist</h3>
        <div id="playlistContainer">
            <div class="track-item" data-index="0">
                <strong>Sample Track 1</strong><br>
                <small>Artist: SoundHelix</small>
            </div>
            <div class="track-item" data-index="1">
                <strong>Sample Track 2</strong><br>
                <small>Artist: SoundHelix</small>
            </div>
            <div class="track-item" data-index="2">
                <strong>Sample Track 3</strong><br>
                <small>Artist: SoundHelix</small>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAqL8w9Qy4N2mRxTkVvJ5HhFgBpL7XcD9E",
            authDomain: "sync-music-player.firebaseapp.com",
            projectId: "sync-music-player",
            storageBucket: "sync-music-player.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456789"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Helper function for DOM selection
        const $ = (id) => document.getElementById(id);

        // Global variables
        let isHost = false;
        let currentSessionId = null;
        let sessionListener = null;
        let currentTrackIndex = 0;
        let isUpdatingFromSync = false;
        let syncUpdateTimeout = null;
        
        const audioPlayer = $('audio-player');
        const playPauseBtn = $('playPauseBtn');
        const progressSlider = $('progressSlider');
        const volumeSlider = $('volumeSlider');
        
        // Sample playlist
        const playlist = [
            {
                title: "Sample Track 1",
                url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3",
                artist: "SoundHelix"
            },
            {
                title: "Sample Track 2", 
                url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3",
                artist: "SoundHelix"
            },
            {
                title: "Sample Track 3",
                url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3",
                artist: "SoundHelix"
            }
        ];

        // Status update function
        function status(message) {
            $('status').textContent = message;
            console.log(message);
        }

        // Initialize the player
        function initializePlayer() {
            // Set initial volume
            audioPlayer.volume = 0.5;
            
            // Audio event listeners
            audioPlayer.addEventListener('loadedmetadata', updateDuration);
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('play', onPlay);
            audioPlayer.addEventListener('pause', onPause);
            audioPlayer.addEventListener('ended', onTrackEnd);
            audioPlayer.addEventListener('error', onAudioError);
            
            // Volume slider
            volumeSlider.addEventListener('input', onVolumeChange);
            
            // Progress slider
            progressSlider.addEventListener('input', onSeek);
            progressSlider.addEventListener('change', onSeek);
            
            // Playlist items click handlers
            document.querySelectorAll('.track-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    selectTrack(index);
                });
            });
            
            status('Player initialized. Create or join a session to start.');
        }

        // Session management
        async function createSession() {
            const sessionId = generateSessionId();
            currentSessionId = sessionId;
            isHost = true;
            
            try {
                const initialData = {
                    host: true,
                    currentTrack: 0,
                    isPlaying: false,
                    currentTime: 0,
                    volume: 0.5,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                    created: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('sessions').doc(sessionId).set(initialData);
                
                $('currentSession').textContent = `Session: ${sessionId} (Host)`;
                $('sessionId').value = sessionId;
                
                loadTrack(0);
                enableHostControls();
                startSessionListener();
                
                status('Session created successfully! Share the session ID with others.');
            } catch (error) {
                status('Error creating session: ' + error.message);
            }
        }

        async function joinSession() {
            const sessionId = $('sessionId').value.trim().toUpperCase();
            if (!sessionId) {
                status('Please enter a session ID');
                return;
            }
            
            try {
                const sessionDoc = await db.collection('sessions').doc(sessionId).get();
                if (!sessionDoc.exists) {
                    status('Session not found. Please check the session ID.');
                    return;
                }
                
                currentSessionId = sessionId;
                isHost = false;
                
                $('currentSession').textContent = `Session: ${sessionId} (Guest)`;
                
                enableGuestControls();
                startSessionListener();
                
                // Sync immediately with current session state
                const sessionData = sessionDoc.data();
                await syncWithSession(sessionData);
                
                status('Joined session successfully!');
            } catch (error) {
                status('Error joining session: ' + error.message);
            }
        }

        function leaveSession() {
            if (sessionListener) {
                sessionListener();
                sessionListener = null;
            }
            
            currentSessionId = null;
            isHost = false;
            
            audioPlayer.pause();
            audioPlayer.src = '';
            
            disableAllControls();
            
            $('currentSession').textContent = '';
            $('currentTrack').textContent = 'No track selected';
            $('trackDetails').textContent = 'Create or join a session to start playing music';
            
            // Reset UI
            document.querySelectorAll('.track-item').forEach(item => {
                item.classList.remove('active');
            });
            
            status('Left session. Create or join a session to continue.');
        }

        function generateSessionId() {
            return Math.random().toString(36).substr(2, 9).toUpperCase();
        }

        // Control management
        function enableHostControls() {
            document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = false);
            volumeSlider.disabled = false;
            progressSlider.disabled = false;
            document.querySelectorAll('.track-item').forEach(item => {
                item.style.cursor = 'pointer';
                item.style.opacity = '1';
            });
        }

        function enableGuestControls() {
            document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = true);
            volumeSlider.disabled = false; // Guests can control their own volume
            progressSlider.disabled = true;
            document.querySelectorAll('.track-item').forEach(item => {
                item.style.cursor = 'not-allowed';
                item.style.opacity = '0.6';
            });
        }

        function disableAllControls() {
            document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = true);
            volumeSlider.disabled = true;
            progressSlider.disabled = true;
            document.querySelectorAll('.track-item').forEach(item => {
                item.style.cursor = 'not-allowed';
                item.style.opacity = '0.6';
            });
        }

        // Session synchronization
        function startSessionListener() {
            if (sessionListener) {
                sessionListener();
            }
            
            sessionListener = db.collection('sessions').doc(currentSessionId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (!isHost) {
                            syncWithSession(data);
                        }
                    } else {
                        status('Session ended or deleted.');
                        leaveSession();
                    }
                }, (error) => {
                    status('Connection error: ' + error.message);
                });
        }

        async function syncWithSession(sessionData) {
            if (isUpdatingFromSync) return;
            
            isUpdatingFromSync = true;
            
            try {
                // Sync track
                if (sessionData.currentTrack !== currentTrackIndex) {
                    currentTrackIndex = sessionData.currentTrack;
                    loadTrack(currentTrackIndex);
                    // Wait for track to load before syncing playback
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Sync volume for guests only (hosts control their own volume)
                if (!isHost && Math.abs(audioPlayer.volume - sessionData.volume) > 0.01) {
                    audioPlayer.volume = sessionData.volume;
                    volumeSlider.value = sessionData.volume;
                    $('volumePercent').textContent = Math.round(sessionData.volume * 100) + '%';
                }
                
                // Sync playback state and time
                const timeDiff = Math.abs(audioPlayer.currentTime - (sessionData.currentTime || 0));
                
                if (sessionData.isPlaying && audioPlayer.paused) {
                    if (timeDiff > 1) {
                        audioPlayer.currentTime = sessionData.currentTime || 0;
                    }
                    try {
                        await audioPlayer.play();
                        playPauseBtn.innerHTML = '<span class="material-icons">pause</span>';
                    } catch (error) {
                        console.log('Play failed:', error);
                    }
                } else if (!sessionData.isPlaying && !audioPlayer.paused) {
                    audioPlayer.pause();
                    playPauseBtn.innerHTML = '<span class="material-icons">play_arrow</span>';
                }
                
                // Sync time if significant difference (accounting for network delay)
                if (!audioPlayer.paused && timeDiff > 2) {
                    audioPlayer.currentTime = sessionData.currentTime || 0;
                }
                
            } catch (error) {
                console.error('Sync error:', error);
            } finally {
                setTimeout(() => {
                    isUpdatingFromSync = false;
                }, 100);
            }
        }

        async function updateSession(updates) {
            if (!isHost || !currentSessionId || isUpdatingFromSync) return;
            
            // Throttle updates to prevent spam
            if (syncUpdateTimeout) {
                clearTimeout(syncUpdateTimeout);
            }
            
            syncUpdateTimeout = setTimeout(async () => {
                try {
                    await db.collection('sessions').doc(currentSessionId).update({
                        ...updates,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error updating session:', error);
                }
            }, 100);
        }

        // Playback controls
        function loadTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            
            currentTrackIndex = index;
            const track = playlist[index];
            
            audioPlayer.src = track.url;
            audioPlayer.load();
            
            $('currentTrack').textContent = track.title;
            $('trackDetails').textContent = `Artist: ${track.artist}`;
            
            // Update playlist UI
            document.querySelectorAll('.track-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
        }

        async function togglePlayPause() {
            if (!isHost || !currentSessionId) return;
            
            try {
                if (audioPlayer.paused) {
                    await audioPlayer.play();
                } else {
                    audioPlayer.pause();
                }
            } catch (error) {
                status('Playback error: ' + error.message);
            }
        }

        function nextTrack() {
            if (!isHost || !currentSessionId) return;
            
            const nextIndex = (currentTrackIndex + 1) % playlist.length;
            loadTrack(nextIndex);
            updateSession({
                currentTrack: nextIndex,
                currentTime: 0,
                isPlaying: false
            });
        }

        function previousTrack() {
            if (!isHost || !currentSessionId) return;
            
            const prevIndex = currentTrackIndex === 0 ? playlist.length - 1 : currentTrackIndex - 1;
            loadTrack(prevIndex);
            updateSession({
                currentTrack: prevIndex,
                currentTime: 0,
                isPlaying: false
            });
        }

        function selectTrack(index) {
            if (!isHost || !currentSessionId) return;
            
            loadTrack(index);
            updateSession({
                currentTrack: index,
                currentTime: 0,
                isPlaying: false
            });
        }

        // Event handlers
        function updateDuration() {
            const duration = formatTime(audioPlayer.duration);
            $('duration').textContent = duration;
            progressSlider.max = audioPlayer.duration || 100;
        }

        function updateProgress() {
            if (!isUpdatingFromSync && !progressSlider.matches(':active')) {
                progressSlider.value = audioPlayer.currentTime || 0;
                const currentTime = formatTime(audioPlayer.currentTime || 0);
                progressSlider.previousElementSibling.textContent = currentTime;
            }
        }

        function onPlay() {
            playPauseBtn.innerHTML = '<span class="material-icons">pause</span>';
            if (isHost && !isUpdatingFromSync) {
                updateSession({
                    isPlaying: true,
                    currentTime: audioPlayer.currentTime || 0
                });
            }
        }

        function onPause() {
            playPauseBtn.innerHTML = '<span class="material-icons">play_arrow</span>';
            if (isHost && !isUpdatingFromSync) {
                updateSession({
                    isPlaying: false,
                    currentTime: audioPlayer.currentTime || 0
                });
            }
        }

        function onTrackEnd() {
            if (isHost) {
                nextTrack();
            }
        }

        function onAudioError(e) {
            status('Audio error: Unable to load track');
            console.error('Audio error:', e);
        }

        function onVolumeChange() {
            const volume = parseFloat(volumeSlider.value);
            audioPlayer.volume = volume;
            $('volumePercent').textContent = Math.round(volume * 100) + '%';
            
            if (isHost) {
                updateSession({ volume });
            }
        }

        function onSeek() {
            if (!isHost) return;
            
            const seekTime = parseFloat(progressSlider.value);
            audioPlayer.currentTime = seekTime;
            
            updateSession({
                currentTime: seekTime
            });
        }

        // Utility functions
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds === null || seconds === undefined) return '0:00';
            
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializePlayer);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (sessionListener) {
                sessionListener();
            }
        });
    </script>
</body>
</html>
